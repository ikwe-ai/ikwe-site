<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study II Execution Tool | Ikwe.ai</title>
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <style>
        :root {
            --primary: #1e3a5f;
            --primary-light: #2d5a8b;
            --accent: #c9a227;
            --danger: #dc3545;
            --success: #28a745;
            --warning: #ffc107;
            --bg: #f8f9fa;
            --card: #ffffff;
            --text: #333;
            --border: #dee2e6;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }
        
        .header {
            background: var(--primary);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .header-badge {
            background: var(--accent);
            color: var(--primary);
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-size: 0.875rem;
            font-weight: 600;
        }
        
        .status-bar {
            background: var(--primary-light);
            color: white;
            padding: 0.5rem 2rem;
            display: flex;
            gap: 2rem;
            font-size: 0.875rem;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .status-dot.green { background: #4ade80; }
        .status-dot.red { background: #f87171; }
        .status-dot.yellow { background: #fbbf24; }
        
        .main-container {
            display: flex;
            height: calc(100vh - 100px);
        }
        
        .sidebar {
            width: 300px;
            background: var(--card);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }
        
        .sidebar-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            font-weight: 600;
        }
        
        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }
        
        .nav-tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
        }
        
        .nav-tab {
            flex: 1;
            padding: 0.75rem;
            text-align: center;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 0.875rem;
            color: var(--text);
            border-bottom: 2px solid transparent;
        }
        
        .nav-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            font-weight: 600;
        }
        
        .scenario-card {
            padding: 0.75rem;
            margin: 0.5rem 0;
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .scenario-card:hover {
            border-color: var(--primary);
            background: #f0f7ff;
        }
        
        .scenario-card.active {
            border-color: var(--primary);
            background: #e8f0fe;
        }
        
        .scenario-id {
            font-size: 0.75rem;
            color: #666;
            font-family: monospace;
        }
        
        .scenario-title {
            font-weight: 500;
            margin: 0.25rem 0;
        }
        
        .scenario-meta {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .tag {
            font-size: 0.7rem;
            padding: 0.125rem 0.375rem;
            border-radius: 3px;
            background: #e9ecef;
        }
        
        .tag.acute { background: #fee2e2; color: #991b1b; }
        .tag.chronic { background: #fef3c7; color: #92400e; }
        .tag.transitional { background: #dbeafe; color: #1e40af; }
        
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .content-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            background: var(--card);
        }
        
        .content-body {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
        }
        
        .panel {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }
        
        .panel-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .panel-body {
            padding: 1rem;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.375rem;
        }
        
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 0.9375rem;
        }
        
        .form-textarea {
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--primary-light);
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-warning {
            background: var(--warning);
            color: var(--text);
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
        }
        
        .btn-outline:hover {
            background: var(--bg);
        }
        
        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.8125rem;
        }
        
        .model-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
        }
        
        .model-card {
            border: 1px solid var(--border);
            border-radius: 6px;
            overflow: hidden;
        }
        
        .model-card-header {
            padding: 0.75rem 1rem;
            background: #f8f9fa;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .model-name {
            font-weight: 600;
        }
        
        .model-status {
            font-size: 0.75rem;
            padding: 0.125rem 0.5rem;
            border-radius: 3px;
        }
        
        .model-status.ready { background: #d1fae5; color: #065f46; }
        .model-status.pending { background: #fef3c7; color: #92400e; }
        .model-status.error { background: #fee2e2; color: #991b1b; }
        
        .model-card-body {
            padding: 1rem;
        }
        
        .response-preview {
            background: #f8f9fa;
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 0.75rem;
            font-size: 0.875rem;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .response-preview.empty {
            color: #999;
            font-style: italic;
        }
        
        .turn-container {
            border: 1px solid var(--border);
            border-radius: 6px;
            margin-bottom: 1rem;
        }
        
        .turn-header {
            padding: 0.5rem 1rem;
            background: #f8f9fa;
            border-bottom: 1px solid var(--border);
            font-weight: 500;
            font-size: 0.875rem;
        }
        
        .turn-content {
            padding: 1rem;
        }
        
        .turn-user, .turn-assistant {
            padding: 0.75rem;
            border-radius: 6px;
            margin-bottom: 0.75rem;
        }
        
        .turn-user {
            background: #e8f0fe;
            border-left: 3px solid var(--primary);
        }
        
        .turn-assistant {
            background: #f0f9f0;
            border-left: 3px solid var(--success);
        }
        
        .turn-label {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 0.25rem;
            color: #666;
        }
        
        .progress-bar {
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--primary);
            transition: width 0.3s;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
        }
        
        .stat-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 1rem;
            text-align: center;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        .stat-label {
            font-size: 0.875rem;
            color: #666;
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #666;
        }
        
        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        
        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal {
            background: var(--card);
            border-radius: 8px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .modal-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-body {
            padding: 1.5rem;
            overflow-y: auto;
        }
        
        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }
        
        /* Toast notifications */
        .toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1100;
        }
        
        .toast {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 0.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .toast.success { border-left: 4px solid var(--success); }
        .toast.error { border-left: 4px solid var(--danger); }
        .toast.warning { border-left: 4px solid var(--warning); }
    </style>
</head>
<body>
    <header class="header">
        <h1>üî¨ Study II Execution Tool</h1>
        <span class="header-badge">v1.0 CANONICAL</span>
    </header>
    
    <div class="status-bar">
        <div class="status-item">
            <span class="status-dot" id="apiStatusDot"></span>
            <span id="apiStatusText">Checking backend...</span>
        </div>
        <div class="status-item">
            <span>Scenarios: <strong id="scenarioCount">0</strong></span>
        </div>
        <div class="status-item">
            <span>Runs: <strong id="runCount">0</strong></span>
        </div>
        <div class="status-item">
            <span>Completed: <strong id="completedCount">0</strong></span>
        </div>
    </div>
    
    <div class="main-container">
        <aside class="sidebar">
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="switchTab('scenarios')">Scenarios</button>
                <button class="nav-tab" onclick="switchTab('runs')">Runs</button>
            </div>
            
            <div class="sidebar-header">
                <span id="sidebarTitle">Scenarios</span>
                <button class="btn btn-sm btn-primary" onclick="openAddModal()">+ Add</button>
            </div>
            
            <div class="sidebar-content" id="sidebarContent">
                <!-- Dynamic content -->
            </div>
        </aside>
        
        <main class="main-content">
            <div class="content-header">
                <h2 id="contentTitle">Dashboard</h2>
            </div>
            
            <div class="content-body" id="contentBody">
                <!-- Dynamic content -->
            </div>
        </main>
    </div>
    
    <!-- Add Scenario Modal -->
    <div class="modal-overlay" id="addScenarioModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Add New Scenario</h3>
                <button class="close-btn" onclick="closeModal('addScenarioModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Case Source ID</label>
                    <input type="text" class="form-input" id="caseSourceId" placeholder="e.g., PUBLIC-CASE-001">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Harm Category</label>
                        <select class="form-select" id="harmCategory">
                            <option value="self-harm">Self-Harm</option>
                            <option value="crisis">Crisis</option>
                            <option value="vulnerability">Vulnerability</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Vulnerability Type</label>
                        <select class="form-select" id="vulnerabilityType">
                            <option value="ACUTE">Acute</option>
                            <option value="CHRONIC">Chronic</option>
                            <option value="TRANSITIONAL">Transitional</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Intensity Level (1-5)</label>
                        <select class="form-select" id="intensityLevel">
                            <option value="1">1 - Mild</option>
                            <option value="2">2</option>
                            <option value="3" selected>3 - Moderate</option>
                            <option value="4">4</option>
                            <option value="5">5 - Severe</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Explicit Distress</label>
                        <select class="form-select" id="explicitDistress">
                            <option value="YES">Yes</option>
                            <option value="NO">No</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Support Seeking</label>
                        <select class="form-select" id="supportSeeking">
                            <option value="YES">Yes</option>
                            <option value="NO">No</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Context/Setup</label>
                    <textarea class="form-textarea" id="scenarioContext" placeholder="Brief context for the scenario..."></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">User Turn 1</label>
                    <textarea class="form-textarea" id="userTurn1" placeholder="First user message..."></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">User Turn 2 (optional)</label>
                    <textarea class="form-textarea" id="userTurn2" placeholder="Second user message..."></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">User Turn 3 (optional)</label>
                    <textarea class="form-textarea" id="userTurn3" placeholder="Third user message..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('addScenarioModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveScenario()">Save Scenario</button>
            </div>
        </div>
    </div>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
        const API_BASE = '/.netlify/functions';
        
        // Get auth token for API calls
        function getAuthHeaders() {
            const user = netlifyIdentity?.currentUser();
            const token = user?.token?.access_token;
            return token ? { 'Authorization': `Bearer ${token}` } : {};
        }
        
        let scenarios = [];
        let runs = [];
        let currentTab = 'scenarios';
        let selectedScenario = null;
        let selectedRun = null;
        
        // ========================================
        // INITIALIZATION
        // ========================================
        
        async function init() {
            await checkHealth();
            await loadData();
            renderDashboard();
        }
        
        async function checkHealth() {
            try {
                const res = await fetch(`${API_BASE}/health`, {
                    headers: getAuthHeaders()
                });
                const data = await res.json();
                
                const dot = document.getElementById('apiStatusDot');
                const text = document.getElementById('apiStatusText');
                
                if (data.status === 'ok') {
                    dot.className = 'status-dot green';
                    const apis = [];
                    if (data.apis.anthropic) apis.push('Claude');
                    if (data.apis.openai) apis.push('GPT');
                    if (data.apis.google) apis.push('Gemini');
                    text.textContent = apis.length ? `Connected: ${apis.join(', ')}` : 'Backend connected (no APIs)';
                } else {
                    dot.className = 'status-dot red';
                    text.textContent = 'Backend error';
                }
            } catch (e) {
                document.getElementById('apiStatusDot').className = 'status-dot red';
                document.getElementById('apiStatusText').textContent = 'Backend not running';
            }
        }
        
        async function loadData() {
            try {
                const headers = getAuthHeaders();
                const [scenariosRes, runsRes, statsRes] = await Promise.all([
                    fetch(`${API_BASE}/scenarios`, { headers }),
                    fetch(`${API_BASE}/runs`, { headers }),
                    fetch(`${API_BASE}/stats`, { headers })
                ]);
                
                scenarios = await scenariosRes.json();
                runs = await runsRes.json();
                const stats = await statsRes.json();
                
                document.getElementById('scenarioCount').textContent = stats.total_scenarios;
                document.getElementById('runCount').textContent = stats.total_runs;
                document.getElementById('completedCount').textContent = stats.completed_runs;
                
                renderSidebar();
            } catch (e) {
                console.error('Failed to load data:', e);
            }
        }
        
        // ========================================
        // NAVIGATION
        // ========================================
        
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.nav-tab:nth-child(${tab === 'scenarios' ? 1 : 2})`).classList.add('active');
            document.getElementById('sidebarTitle').textContent = tab === 'scenarios' ? 'Scenarios' : 'Runs';
            renderSidebar();
            
            if (tab === 'scenarios') {
                renderDashboard();
            } else {
                renderRunsList();
            }
        }
        
        // ========================================
        // RENDERING
        // ========================================
        
        function renderSidebar() {
            const container = document.getElementById('sidebarContent');
            
            if (currentTab === 'scenarios') {
                if (scenarios.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üìã</div>
                            <p>No scenarios yet</p>
                            <button class="btn btn-primary btn-sm" onclick="openAddModal()">Add First Scenario</button>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = scenarios.map(s => `
                    <div class="scenario-card ${selectedScenario?.scenario_id === s.scenario_id ? 'active' : ''}" 
                         onclick="selectScenario('${s.scenario_id}')">
                        <div class="scenario-id">${s.scenario_id}</div>
                        <div class="scenario-title">${s.case_source_id || 'Untitled'}</div>
                        <div class="scenario-meta">
                            <span class="tag ${s.vulnerability_type?.toLowerCase()}">${s.vulnerability_type}</span>
                            <span class="tag">Level ${s.intensity_level}</span>
                        </div>
                    </div>
                `).join('');
            } else {
                if (runs.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üî¨</div>
                            <p>No runs yet</p>
                            <p style="font-size: 0.875rem; margin-top: 0.5rem;">Select a scenario to start testing</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = runs.map(r => `
                    <div class="scenario-card ${selectedRun?.run_id === r.run_id ? 'active' : ''}"
                         onclick="selectRun('${r.run_id}')">
                        <div class="scenario-id">${r.run_id}</div>
                        <div class="scenario-title">${r.model}</div>
                        <div class="scenario-meta">
                            <span class="tag">${r.scenario_id}</span>
                            <span class="tag ${r.status === 'completed' ? 'success' : ''}">${r.status}</span>
                        </div>
                    </div>
                `).join('');
            }
        }
        
        function renderDashboard() {
            document.getElementById('contentTitle').textContent = 'Dashboard';
            
            const completedRuns = runs.filter(r => r.status === 'completed').length;
            const scoredRuns = runs.filter(r => r.scored).length;
            
            document.getElementById('contentBody').innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">${scenarios.length}</div>
                        <div class="stat-label">Scenarios</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${runs.length}</div>
                        <div class="stat-label">Total Runs</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${completedRuns}</div>
                        <div class="stat-label">Completed</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${scoredRuns}</div>
                        <div class="stat-label">Scored</div>
                    </div>
                </div>
                
                <div class="panel" style="margin-top: 1.5rem;">
                    <div class="panel-header">
                        <span>Progress</span>
                        <span>${runs.length > 0 ? Math.round(completedRuns / runs.length * 100) : 0}%</span>
                    </div>
                    <div class="panel-body">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${runs.length > 0 ? (completedRuns / runs.length * 100) : 0}%"></div>
                        </div>
                    </div>
                </div>
                
                <div class="panel">
                    <div class="panel-header">
                        <span>Quick Actions</span>
                    </div>
                    <div class="panel-body">
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                            <button class="btn btn-primary" onclick="openAddModal()">+ Add Scenario</button>
                            <button class="btn btn-outline" onclick="exportSpreadsheet()">üìä Export for Scoring</button>
                            <button class="btn btn-outline" onclick="exportFull()">üíæ Export Full Data</button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function selectScenario(scenarioId) {
            selectedScenario = scenarios.find(s => s.scenario_id === scenarioId);
            renderSidebar();
            renderScenarioDetail();
        }
        
        function renderScenarioDetail() {
            if (!selectedScenario) return;
            
            document.getElementById('contentTitle').textContent = selectedScenario.scenario_id;
            
            const scenarioRuns = runs.filter(r => r.scenario_id === selectedScenario.scenario_id);
            
            document.getElementById('contentBody').innerHTML = `
                <div class="panel">
                    <div class="panel-header">
                        <span>Scenario Details</span>
                        <button class="btn btn-sm btn-outline" onclick="editScenario('${selectedScenario.scenario_id}')">Edit</button>
                    </div>
                    <div class="panel-body">
                        <div class="form-row" style="margin-bottom: 1rem;">
                            <div>
                                <strong>Case Source:</strong> ${selectedScenario.case_source_id || 'N/A'}
                            </div>
                            <div>
                                <strong>Category:</strong> ${selectedScenario.harm_category}
                            </div>
                            <div>
                                <strong>Type:</strong> 
                                <span class="tag ${selectedScenario.vulnerability_type?.toLowerCase()}">${selectedScenario.vulnerability_type}</span>
                            </div>
                            <div>
                                <strong>Intensity:</strong> ${selectedScenario.intensity_level}/5
                            </div>
                        </div>
                        
                        ${selectedScenario.context ? `
                            <div style="margin-bottom: 1rem;">
                                <strong>Context:</strong>
                                <p style="color: #666;">${selectedScenario.context}</p>
                            </div>
                        ` : ''}
                        
                        <div>
                            <strong>User Turns:</strong>
                            ${(selectedScenario.user_turns || []).map((turn, i) => `
                                <div class="turn-user" style="margin-top: 0.5rem;">
                                    <div class="turn-label">Turn ${i + 1}</div>
                                    ${turn}
                                </div>
                            `).join('') || '<p style="color: #999;">No turns defined</p>'}
                        </div>
                    </div>
                </div>
                
                <div class="panel">
                    <div class="panel-header">
                        <span>Test This Scenario</span>
                    </div>
                    <div class="panel-body">
                        <p style="margin-bottom: 1rem;">Select models to test:</p>
                        <div class="model-grid">
                            ${Object.entries({
                                'claude-sonnet': 'Claude Sonnet 4',
                                'claude-opus': 'Claude Opus 4',
                                'gpt-4o': 'GPT-4o',
                                'gpt-4-turbo': 'GPT-4 Turbo',
                                'gemini-pro': 'Gemini Pro',
                                'gemini-flash': 'Gemini Flash'
                            }).map(([id, name]) => `
                                <div class="model-card">
                                    <div class="model-card-header">
                                        <span class="model-name">${name}</span>
                                        <button class="btn btn-sm btn-primary" onclick="runTest('${selectedScenario.scenario_id}', '${id}')">
                                            ‚ñ∂ Run
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
                
                ${scenarioRuns.length > 0 ? `
                    <div class="panel">
                        <div class="panel-header">
                            <span>Existing Runs (${scenarioRuns.length})</span>
                        </div>
                        <div class="panel-body">
                            ${scenarioRuns.map(r => `
                                <div class="scenario-card" onclick="selectRun('${r.run_id}'); switchTab('runs');">
                                    <div class="scenario-id">${r.run_id}</div>
                                    <div class="scenario-title">${r.model}</div>
                                    <div class="scenario-meta">
                                        <span class="tag">${r.condition}</span>
                                        <span class="tag ${r.status === 'completed' ? 'success' : ''}">${r.status}</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
            `;
        }
        
        function renderRunsList() {
            document.getElementById('contentTitle').textContent = 'All Runs';
            
            if (runs.length === 0) {
                document.getElementById('contentBody').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üî¨</div>
                        <h3>No runs yet</h3>
                        <p>Select a scenario and run tests to see results here.</p>
                    </div>
                `;
                return;
            }
            
            document.getElementById('contentBody').innerHTML = `
                <div class="panel">
                    <div class="panel-body">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="border-bottom: 2px solid var(--border);">
                                    <th style="text-align: left; padding: 0.75rem;">Run ID</th>
                                    <th style="text-align: left; padding: 0.75rem;">Scenario</th>
                                    <th style="text-align: left; padding: 0.75rem;">Model</th>
                                    <th style="text-align: left; padding: 0.75rem;">Condition</th>
                                    <th style="text-align: left; padding: 0.75rem;">Turns</th>
                                    <th style="text-align: left; padding: 0.75rem;">Status</th>
                                    <th style="text-align: left; padding: 0.75rem;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${runs.map(r => `
                                    <tr style="border-bottom: 1px solid var(--border);">
                                        <td style="padding: 0.75rem; font-family: monospace;">${r.run_id}</td>
                                        <td style="padding: 0.75rem;">${r.scenario_id}</td>
                                        <td style="padding: 0.75rem;">${r.model}</td>
                                        <td style="padding: 0.75rem;">${r.condition}</td>
                                        <td style="padding: 0.75rem;">${r.turns?.length || 0}</td>
                                        <td style="padding: 0.75rem;">
                                            <span class="tag ${r.status === 'completed' ? 'success' : ''}">${r.status}</span>
                                        </td>
                                        <td style="padding: 0.75rem;">
                                            <button class="btn btn-sm btn-outline" onclick="viewRun('${r.run_id}')">View</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }
        
        function selectRun(runId) {
            selectedRun = runs.find(r => r.run_id === runId);
            renderSidebar();
            viewRun(runId);
        }
        
        function viewRun(runId) {
            const run = runs.find(r => r.run_id === runId);
            if (!run) return;
            
            selectedRun = run;
            const scenario = scenarios.find(s => s.scenario_id === run.scenario_id);
            
            document.getElementById('contentTitle').textContent = run.run_id;
            
            document.getElementById('contentBody').innerHTML = `
                <div class="panel">
                    <div class="panel-header">
                        <span>Run Details</span>
                        <span class="tag ${run.status === 'completed' ? 'success' : ''}">${run.status}</span>
                    </div>
                    <div class="panel-body">
                        <div class="form-row">
                            <div><strong>Scenario:</strong> ${run.scenario_id}</div>
                            <div><strong>Model:</strong> ${run.model}</div>
                            <div><strong>Condition:</strong> ${run.condition}</div>
                            <div><strong>Scored:</strong> ${run.scored ? 'Yes' : 'No'}</div>
                        </div>
                    </div>
                </div>
                
                <div class="panel">
                    <div class="panel-header">
                        <span>Conversation</span>
                    </div>
                    <div class="panel-body">
                        ${(run.turns || []).length > 0 ? run.turns.map((turn, i) => `
                            <div class="turn-container">
                                <div class="turn-header">Turn ${i + 1}</div>
                                <div class="turn-content">
                                    <div class="turn-user">
                                        <div class="turn-label">User</div>
                                        ${turn.user_content}
                                    </div>
                                    <div class="turn-assistant">
                                        <div class="turn-label">Assistant (${run.model})</div>
                                        ${turn.assistant_content}
                                    </div>
                                </div>
                            </div>
                        `).join('') : '<p style="color: #999;">No turns recorded yet</p>'}
                    </div>
                </div>
            `;
        }
        
        // ========================================
        // ACTIONS
        // ========================================
        
        function openAddModal() {
            document.getElementById('addScenarioModal').classList.add('active');
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }
        
        async function saveScenario() {
            const userTurns = [];
            ['userTurn1', 'userTurn2', 'userTurn3'].forEach(id => {
                const val = document.getElementById(id).value.trim();
                if (val) userTurns.push(val);
            });
            
            const scenario = {
                case_source_id: document.getElementById('caseSourceId').value,
                harm_category: document.getElementById('harmCategory').value,
                vulnerability_type: document.getElementById('vulnerabilityType').value,
                intensity_level: parseInt(document.getElementById('intensityLevel').value),
                explicit_distress: document.getElementById('explicitDistress').value,
                support_seeking: document.getElementById('supportSeeking').value,
                context: document.getElementById('scenarioContext').value,
                user_turns: userTurns
            };
            
            try {
                const res = await fetch(`${API_BASE}/scenarios`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    },
                    body: JSON.stringify(scenario)
                });
                
                if (res.ok) {
                    showToast('Scenario saved!', 'success');
                    closeModal('addScenarioModal');
                    await loadData();
                } else {
                    showToast('Failed to save scenario', 'error');
                }
            } catch (e) {
                showToast('Error: ' + e.message, 'error');
            }
        }
        
        async function runTest(scenarioId, modelId) {
            const scenario = scenarios.find(s => s.scenario_id === scenarioId);
            if (!scenario || !scenario.user_turns?.length) {
                showToast('Scenario has no user turns defined', 'error');
                return;
            }
            
            showToast(`Starting test: ${modelId}...`, 'warning');
            
            try {
                // Create run
                const runRes = await fetch(`${API_BASE}/runs`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    },
                    body: JSON.stringify({
                        scenario_id: scenarioId,
                        model: modelId,
                        condition: 'baseline'
                    })
                });
                
                const runData = await runRes.json();
                const runId = runData.run.run_id;
                
                // Run each turn
                const messages = [];
                for (const userTurn of scenario.user_turns) {
                    messages.push({ role: 'user', content: userTurn });
                    
                    // Fetch model response
                    const fetchRes = await fetch(`${API_BASE}/fetch`, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            ...getAuthHeaders()
                        },
                        body: JSON.stringify({ model: modelId, messages })
                    });
                    
                    const fetchData = await fetchRes.json();
                    
                    if (fetchData.error) {
                        showToast(`Error: ${fetchData.error}`, 'error');
                        return;
                    }
                    
                    const assistantContent = fetchData.response;
                    messages.push({ role: 'assistant', content: assistantContent });
                    
                    // Save turn
                    await fetch(`${API_BASE}/runs/${runId}/turn`, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            ...getAuthHeaders()
                        },
                        body: JSON.stringify({
                            user_content: userTurn,
                            assistant_content: assistantContent
                        })
                    });
                }
                
                // Mark completed
                await fetch(`${API_BASE}/runs/${runId}`, {
                    method: 'PUT',
                    headers: { 
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    },
                    body: JSON.stringify({ status: 'completed' })
                });
                
                showToast(`Test completed: ${runId}`, 'success');
                await loadData();
                
            } catch (e) {
                showToast('Test failed: ' + e.message, 'error');
            }
        }
        
        async function exportSpreadsheet() {
            const token = netlifyIdentity?.currentUser()?.token?.access_token;
            window.open(`${API_BASE}/export?token=${token || ''}`, '_blank');
        }
        
        async function exportFull() {
            showToast('Full export available via GitHub repository', 'warning');
        }
        
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <span>${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ö†Ô∏è'}</span>
                <span>${message}</span>
            `;
            container.appendChild(toast);
            
            setTimeout(() => toast.remove(), 4000);
        }
        
        // Initialize
        init();
    </script>
</body>
</html>
